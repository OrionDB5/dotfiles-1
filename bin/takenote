#!/bin/sh
# written by Shotaro Fujimoto (https://github.com/ssh0)
# first edited: 2015-06-20

takenote() {
  local get_dir=false
  local get_name=false
  local alternative=false
  local show_list=false
  local filercmd=ranger
  local filer=false
  local rootdir=$HOME/Workspace/blog
  local pattern='s/note_\([0-9]\{2\}\).md/\1/p'

  show_usage() {
    echo "Usage: takenote [-d dir] [-o filename] [-g editor] [-l] [-r] [-h]"
    echo "  -d dir     : set the saving directory (default: '$rootdir')"
    echo "  -o filename: set the file's name"
    echo "  -g editor  : open with an altenative program (default: '$EDITOR')"
    echo "  -l         : list the today's files"
    echo "  -r         : open the today's dir or the root dir with the filer (default: '$filercmd')"
    echo "  -h         : show this message"
  }

  check_dir() {
    if [ ! -e "$1" ]; then
      echo "Directory '$1' doesn't exist."
      return 1
    fi
  }

  while getopts d:o:g:lrh OPT
  do
    case $OPT in
      "d" ) get_dir=true
            dir="$OPTARG" ;;
      "o" ) get_name=true
            name="$OPTARG" ;;
      "g" ) alternative=true
            editor="$OPTARG" ;;
      "l" ) show_list=true ;;
      "r" ) filer=true ;;
      "h" ) show_usage;
            return 0 ;;
        * ) show_usage;
            return 0 ;;
    esac
  done

  # set the saving directory
  if ! $get_dir; then
    if check_dir "$rootdir"; then
      daydir=$(date +%Y-%m-%d)
      dir=$rootdir/$daydir
    else
      return 1
    fi
  fi

  # only show existing file in the directory
  if $show_list; then
    if check_dir "$dir"; then
      list=$(ls "$dir")
      echo "$list"
    fi
    return 0
  fi

  # move to today's directory by the user defined filer
  if $filer; then
    if [ ! -e "$dir" ]; then
      echo "Today's directory has not been created yet."
      echo "Open root directory '$rootdir' ..."
      "$filercmd" "$rootdir"
    else
      "$filercmd" "$dir"
    fi
    return 0
  fi

  # set the filename
  if ! $get_name; then
    if [ ! -e "$dir" ]; then
      i=1
    else
      i=$(( $(ls "$dir" | sed -n $pattern | tail -n 1) + 1 ))
    fi
    name="$(printf note_%02d.md "$i")"
  fi

  # change directory
  cd $dir

  if $alternative; then
    $editor "$dir/$name"
  else
    $EDITOR "$dir/$name"
  fi

  return 0
}

takenote $@
